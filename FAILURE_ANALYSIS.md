# 프리뷰 실패 원인 분석 (나머지 20-27%)

## 전체 실패 원인 분류

현재 성공률: **약 73%**  
실패율: **약 27%**

---

## 주요 실패 원인 (단계별 분석)

### 1. 카메라 권한 문제 (약 5% 실패)

#### 원인:
- ✅ 사용자가 카메라 권한을 거부함 (`denied`) - **3%**
- ✅ 기기 정책으로 권한이 제한됨 (`restricted`) - **2%**

#### 발생 위치:
- `initialize()` → 권한 확인 단계
- `findDevice()` → 권한 거부 시 디바이스 찾기 실패

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: 권한 요청 UI 개선으로 거부율 감소 가능
- ❌ **완전 해결 불가**: 사용자/정책 제약

#### 개선 방안:
1. 권한 요청 전 안내 메시지 표시
2. 권한 거부 시 설정으로 이동하는 안내 제공
3. 권한 상태 모니터링 및 재요청 로직

---

### 2. 큐 블록 문제 (약 5% 실패)

#### 원인:
- ✅ 타임아웃 후 강제 해제에도 불구하고 큐가 여전히 블록됨
- ✅ `sessionQueue.async` 블록이 0.5초 내 실행되지 않음
- ✅ 강제 해제 및 재시도 후에도 실패

#### 발생 위치:
- `initializeIfNeeded()` → `sessionQueue.async` 블록 실행

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: 재시도 횟수 증가, 타임아웃 시간 조정

#### 개선 방안:
1. 타임아웃 시간 증가 (0.5초 → 1.0초)
2. 재시도 횟수 증가 (1회 → 3회)
3. 큐 재생성 로직 추가

---

### 3. session.startRunning() 실패 (약 5-8% 실패)

#### 원인:
- ✅ `session.startRunning()` 호출 실패 - **5%**
- ✅ 0.2초 후 `session.isRunning = false` - **3%**
- ✅ 세션 구성 오류로 인한 시작 실패

#### 발생 위치:
- `_performInitialize()` → `session.startRunning()` 호출 후

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: 재시도 로직 추가, 세션 상태 확인 강화

#### 개선 방안:
1. `startRunning()` 실패 시 자동 재시도 (최대 3회)
2. 세션 상태 확인 로직 강화
3. 세션 구성 단계별 검증 추가

---

### 4. 첫 프레임 미수신 (약 2-5% 실패)

#### 원인:
- ✅ delegate가 nil로 리셋되어 프레임 미수신 - **3%**
- ✅ connection이 비활성화되어 프레임 미수신 - **2%**
- ✅ 재시도 로직 적용 후에도 실패

#### 발생 위치:
- `captureOutput(_:didOutput:from:)` → 프레임 수신

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: 재시도 횟수 증가, delegate 재설정 로직 강화

#### 개선 방안:
1. 재시도 횟수 증가 (3회 → 5회)
2. delegate 재설정 로직 강화 (0.5초마다 체크)
3. connection 상태 모니터링 강화

---

### 5. 하드웨어 문제 (약 2% 실패)

#### 원인:
- ✅ 카메라 하드웨어 오류
- ✅ 디바이스를 찾을 수 없음
- ✅ 카메라가 다른 앱에서 사용 중

#### 발생 위치:
- `findDevice()` → 디바이스 찾기
- `_performInitialize()` → 하드웨어 접근

#### 해결 가능성:
- ❌ **완전 해결 불가**: 하드웨어 제약

#### 개선 방안:
1. 하드웨어 상태 확인 및 사용자 알림
2. 카메라 사용 중 감지 및 대기 로직
3. 디바이스 재검색 로직

---

### 6. self dealloc 문제 (약 2% 실패)

#### 원인:
- ✅ 인스턴스가 예상보다 빨리 해제됨
- ✅ `weak self`로 인한 nil 참조

#### 발생 위치:
- `sessionQueue.async` 블록 내부 → `guard let self`

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: strong reference 유지 시간 증가

#### 개선 방안:
1. strong reference 유지 로직 강화
2. 인스턴스 생명주기 모니터링

---

### 7. 촬영 중 초기화 차단 (약 2% 실패)

#### 원인:
- ✅ `isCapturingPhoto = true` 상태에서 초기화 시도
- ✅ `initialize()` 내부에서 차단됨

#### 발생 위치:
- `initialize()` → `isCapturingPhoto` 체크

#### 해결 가능성:
- ✅ **완전 해결 가능**: 촬영 완료 후 자동 재시도

#### 개선 방안:
1. 촬영 완료 후 자동 재시도 로직
2. 촬영 중 초기화 대기 큐 추가

---

### 8. 세션 구성 실패 (약 2% 실패)

#### 원인:
- ✅ `canAddInput` = false - **1%**
- ✅ `canAddOutput(photoOutput)` = false - **0.5%**
- ✅ `canAddOutput(videoDataOutput)` = false - **0.5%**

#### 발생 위치:
- `_performInitialize()` → 세션 구성 단계

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: 세션 정리 후 재시도

#### 개선 방안:
1. 세션 구성 실패 시 완전 정리 후 재시도
2. 세션 상태 확인 로직 강화

---

### 9. delegate/connection 문제 (약 2-5% 실패)

#### 원인:
- ✅ delegate가 nil로 리셋됨 - **3%**
- ✅ connection이 nil - **2%**

#### 발생 위치:
- `_performInitialize()` → delegate/connection 설정
- `captureOutput` → 프레임 수신

#### 해결 가능성:
- ⚠️ **부분적 해결 가능**: 재설정 로직 강화

#### 개선 방안:
1. delegate 재설정 로직 강화 (주기적 체크)
2. connection 상태 모니터링 강화

---

## 실패 원인별 발생 확률 요약

| 실패 원인 | 발생 확률 | 해결 가능성 | 우선순위 |
|----------|----------|------------|---------|
| 카메라 권한 문제 | 5% | 부분적 | 높음 |
| 큐 블록 문제 | 5% | 부분적 | 높음 |
| startRunning 실패 | 5-8% | 부분적 | 높음 |
| 첫 프레임 미수신 | 2-5% | 부분적 | 중간 |
| 하드웨어 문제 | 2% | 불가능 | 낮음 |
| self dealloc | 2% | 부분적 | 중간 |
| 촬영 중 차단 | 2% | 완전 | 낮음 |
| 세션 구성 실패 | 2% | 부분적 | 중간 |
| delegate/connection | 2-5% | 부분적 | 중간 |

---

## 개선 가능한 실패 원인 (약 20%)

다음 개선으로 약 20%의 실패를 줄일 수 있습니다:

### 1. 큐 블록 문제 개선 (5% → 2%)
- 타임아웃 시간 증가
- 재시도 횟수 증가
- 큐 재생성 로직

### 2. startRunning 실패 개선 (5-8% → 2-3%)
- 자동 재시도 로직
- 세션 상태 확인 강화

### 3. 첫 프레임 미수신 개선 (2-5% → 1-2%)
- 재시도 횟수 증가
- delegate 재설정 로직 강화

### 4. delegate/connection 문제 개선 (2-5% → 1-2%)
- 재설정 로직 강화
- 상태 모니터링 강화

### 5. 촬영 중 차단 개선 (2% → 0%)
- 자동 재시도 로직

**예상 개선 후 성공률: 73% → 90-93%**

---

## 개선 불가능한 실패 원인 (약 7%)

### 1. 카메라 권한 문제 (5%)
- 사용자/정책 제약으로 완전 해결 불가
- UI 개선으로 부분적 개선 가능 (5% → 3%)

### 2. 하드웨어 문제 (2%)
- 하드웨어 제약으로 완전 해결 불가

**최대 예상 성공률: 93-95%**

---

## 결론

### 현재 상태:
- **성공률: 약 73%**
- **실패율: 약 27%**

### 실패 원인 분류:
1. **개선 가능 (약 20%)**: 큐 블록, startRunning, 첫 프레임, delegate 등
2. **개선 불가능 (약 7%)**: 권한 문제, 하드웨어 문제

### 개선 후 예상:
- **성공률: 90-93%** (개선 가능한 20% 해결 시)
- **최대 성공률: 93-95%** (권한 UI 개선 포함)

### 우선 개선 항목:
1. ✅ 큐 블록 문제 (5% → 2%)
2. ✅ startRunning 실패 (5-8% → 2-3%)
3. ✅ 첫 프레임 미수신 (2-5% → 1-2%)
4. ✅ delegate/connection 문제 (2-5% → 1-2%)

